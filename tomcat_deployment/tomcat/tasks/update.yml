---
#  - name: downloading jenkisn war file file
#    get_url: url=https://updates.jenkins-ci.org/download/war/2.34/jenkins.war dest=/opt/tomcat/apache-tomcat-7.0.67/webapps

#  - name: shutting down tomcat
#    service: name=tomcat state=stopped

#  - name: archiving existing artifact
#    shell: tar cvzf /opt/tomcat/{{tomcat_directory_name}}/jenkins.tar /opt/tomcat/{{tomcat_directory_name}}/webapps/jenkins.war

#  - name: Cleaning up work duirectory
#    shell: rm -rf /opt/tomcat/{{tomcat_directory_name}}/webapps/*
  
  - name: copying new artifact
#    get_url: url="https://updates.jenkins-ci.org/latest/jenkins.war" dest=/opt/tomcat/{{tomcat_directory_name}}/webapps/ mode=0755 force=yes
    get_url: url="https://updates.jenkins-ci.org/download/war/2.51/jenkins.war" dest=/opt/tomcat/{{tomcat_directory_name}}/webapps/ mode=0755 group=tomcat owner=tomcat force=yes

  - name: checking health
    uri: url=http://{{hostname}}:{{http_port}}/jenkins user=tomcat_admin_username password=tomcat_admin_password status_code=200 timeout=300
    register: result_health_check
    ignore_errors: yes
  - name: reverting deployment if health check fails
    unarchive: /opt/tomcat/{{tomcat_directory_name}}/jenkins.tar dest=/opt/tomcat/{{tomcat_directory_name}}/webapps/ remote_src=yes mode=u+x
    when: result_health_check |failed
#  - name: starting tomcat
#    service: name=tomcat state=started

#  - name: wait for tomcat to start
#    wait_for: port={{http_port}} timeout=300

